<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPG TV Guide</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
    }

    h1 {
      text-align: center;
      padding: 10px;
      background: #222;
      margin: 0;
      font-size: 1.2rem;
    }

    .epg-container {
      overflow-x: auto;
      overflow-y: auto;
      height: calc(100vh - 60px);
    }

    .epg-grid {
      display: grid;
      grid-template-columns: 150px repeat(auto-fit, minmax(100px, 1fr));
      min-width: 1000px;
    }

    .channel-name {
      background: #222;
      padding: 10px;
      border-bottom: 1px solid #444;
      position: sticky;
      left: 0;
      z-index: 2;
      white-space: nowrap;
    }

    .program {
      background: #333;
      padding: 5px;
      border: 1px solid #444;
      font-size: 0.85rem;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .now-playing {
      background: #ff9800;
      color: #000;
      font-weight: bold;
    }

    .timeline {
      position: sticky;
      top: 0;
      z-index: 3;
      background: #1a1a1a;
      display: flex;
    }

    .timeline .time-slot {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-right: 1px solid #444;
      font-size: 0.8rem;
    }

    .channel-row {
      display: contents;
    }

    .current-time-indicator {
      position: absolute;
      top: 40px;
      height: calc(100% - 40px);
      width: 2px;
      background: red;
      z-index: 5;
    }

    @media (max-width: 600px) {
      .epg-grid {
        grid-template-columns: 100px repeat(auto-fit, minmax(80px, 1fr));
        font-size: 0.75rem;
      }

      .channel-name {
        padding: 5px;
      }

      .program {
        padding: 3px;
      }

      .timeline .time-slot {
        padding: 5px;
      }
    }
  </style>
</head>
<body>
  <h1>TV Guide EPG</h1>
  <div class="epg-container">
    <div id="epg" class="epg-grid"></div>
    <div id="current-time-indicator" class="current-time-indicator"></div>
  </div>

  <script>
    async function loadEPG() {
      const response = await fetch('https://epgnxb.vercel.app/api/epg.xml');
      const text = await response.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, 'application/xml');

      const channels = [...xml.querySelectorAll('channel')].map(channel => ({
        id: channel.getAttribute('id'),
        name: channel.querySelector('display-name')?.textContent || 'Unknown'
      }));

      const programs = [...xml.querySelectorAll('programme')].map(p => ({
        channel: p.getAttribute('channel'),
        start: parseEPGDate(p.getAttribute('start')),
        stop: parseEPGDate(p.getAttribute('stop')),
        title: p.querySelector('title')?.textContent || 'No title'
      }));

      const epg = document.getElementById('epg');

      const earliest = Math.min(...programs.map(p => p.start.getTime()));
      const latest = Math.max(...programs.map(p => p.stop.getTime()));
      const duration = latest - earliest;

      // Timeline
      const timelineRow = document.createElement('div');
      timelineRow.className = 'timeline';
      const timeInterval = 30 * 60 * 1000; // 30 minutes

      for (let t = earliest; t < latest; t += timeInterval) {
        const timeSlot = document.createElement('div');
        timeSlot.className = 'time-slot';
        timeSlot.textContent = new Date(t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        timelineRow.appendChild(timeSlot);
      }
      epg.appendChild(timelineRow);

      // Channel rows
      channels.forEach(channel => {
        const row = document.createElement('div');
        row.className = 'channel-row';

        const channelCell = document.createElement('div');
        channelCell.className = 'channel-name';
        channelCell.textContent = channel.name;
        row.appendChild(channelCell);

        const channelPrograms = programs
          .filter(p => p.channel === channel.id)
          .sort((a, b) => a.start - b.start);

        channelPrograms.forEach(p => {
          const cell = document.createElement('div');
          cell.className = 'program';

          const widthPercent = ((p.stop - p.start) / duration) * 100 * 2; // stretch
          cell.style.width = `${widthPercent}%`;
          cell.textContent = `${p.title}`;

          const now = new Date();
          if (now >= p.start && now <= p.stop) {
            cell.classList.add('now-playing');
          }

          row.appendChild(cell);
        });

        epg.appendChild(row);
      });

      updateTimeIndicator(earliest, latest);
      setInterval(() => updateTimeIndicator(earliest, latest), 60000);
    }

    function parseEPGDate(raw) {
      const match = raw.match(/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})\s*([+\-]\d{4})?/);
      if (!match) return new Date(NaN);
      const [_, y, m, d, h, min, s, tz] = match;
      const iso = `${y}-${m}-${d}T${h}:${min}:${s}${tz ? tz.slice(0, 3) + ":" + tz.slice(3) : "Z"}`;
      return new Date(iso);
    }

    function updateTimeIndicator(startTime, endTime) {
      const now = Date.now();
      const duration = endTime - startTime;
      const elapsed = now - startTime;

      const epgGrid = document.querySelector('.epg-grid');
      const indicator = document.getElementById('current-time-indicator');

      if (now < startTime || now > endTime) {
        indicator.style.display = 'none';
        return;
      }

      indicator.style.display = 'block';
      const containerWidth = epgGrid.scrollWidth;
      const left = (elapsed / duration) * containerWidth;
      indicator.style.left = `${left}px`;
    }

    loadEPG();
    setInterval(loadEPG, 60 * 60 * 1000); // Refresh every hour
  </script>
</body>
</html>
